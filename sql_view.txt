CREATE VIEW page_analytics AS
SELECT vt.visit_ID,
	   page,
       browser,
       ip,
       username,
       timestamp 
FROM visit_tracking vt
LEFT JOIN page p ON vt.page_ID = p.page_ID
LEFT JOIN browser b ON vt.browser_ID = b.browser_ID
LEFT JOIN logged_user lu ON vt.visit_ID = lu.visit_ID
LEFT JOIN user u ON lu.user_ID=u.user_ID



CREATE VIEW page_views AS
SELECT page AS "Page", count(vt.page_ID) AS "Visits"
FROM visit_tracking vt
JOIN page p ON vt.page_ID = p.page_ID
GROUP BY vt.page_ID

CREATE VIEW ip_visits AS
SELECT vt.ip AS "IP", count(vt.ip) AS "Visits"
FROM visit_tracking vt
GROUP BY vt.ip
ORDER BY Visits DESC

CREATE VIEW incident_report AS
SELECT i.incident_ID,
	i_t.incident_type,
    s.severity,
    i.description
FROM incident i
JOIN incident_type i_t ON i.incident_type_ID = i_t.incident_type_ID
JOIN severity s ON i.severity_ID = s.severity_ID


CREATE VIEW all_incidents AS
SELECT i.incident_ID, it.incident_type, sv.severity, i.description, i.created, s.status, ist.user_ID
FROM incident i
JOIN incident_type it ON i.incident_type_ID = it.incident_type_ID
JOIN severity sv ON i.severity_ID = sv.severity_ID
JOIN incident_status ist ON i.incident_ID = ist.incident_ID
JOIN status s ON ist.status_ID = s.status_ID
WHERE ist.timestamp = (SELECT MAX(timestamp) FROM incident_status WHERE incident_ID = i.incident_ID)
ORDER BY i.incident_ID DESC


CREATE VIEW reporter_incident AS
SELECT 
    i.incident_ID,
    i.description,
    i.created,
    it.incident_type,
    sv.severity,
    s.status,
    u.username,
    ist.timestamp
FROM incident i
JOIN incident_type it ON i.incident_type_ID = it.incident_type_ID
JOIN severity sv ON i.severity_ID = sv.severity_ID
JOIN (
    SELECT 
        is1.incident_ID,
        is1.status_ID,
        is1.user_ID,
        is1.timestamp
    FROM incident_status is1
    INNER JOIN (
        SELECT 
            incident_ID, 
            MAX(timestamp) AS latest_timestamp
        FROM incident_status
        GROUP BY incident_ID
    ) is2 ON is1.incident_ID = is2.incident_ID 
          AND is1.timestamp = is2.latest_timestamp
) ist ON i.incident_ID = ist.incident_ID
JOIN status s ON ist.status_ID = s.status_ID
JOIN user u ON ist.user_ID = u.user_ID



CREATE VIEW all_incidents AS
SELECT i.incident_ID, it.incident_type, sv.severity, i.description, i.created, s.status, ist.user_ID
FROM incident i
JOIN incident_type it ON i.incident_type_ID = it.incident_type_ID
JOIN severity sv ON i.severity_ID = sv.severity_ID
JOIN incident_status ist ON i.incident_ID = ist.incident_ID
JOIN status s ON ist.status_ID = s.status_ID
WHERE (ist.timestamp, ist.i_status_ID) IN (
    SELECT MAX(timestamp), MAX(i_status_ID)
    FROM incident_status
    GROUP BY incident_ID
)
ORDER BY i.incident_ID DESC;



SELECT
    i.incident_ID AS incident_ID,
    i.description AS description,
    i.created AS created,
    it.incident_type AS incident_type,
    sv.severity AS severity,
    latest_status.status AS status,
    first_reporter.username AS username
FROM
    incident i
JOIN
    incident_type it ON i.incident_type_ID = it.incident_type_ID
JOIN
    severity sv ON i.severity_ID = sv.severity_ID
JOIN (
    SELECT
        is1.incident_ID AS incident_ID,
        is1.status_ID AS status_ID,
        is1.user_ID AS user_ID,
        is1.timestamp AS timestamp,
        s.status AS status
    FROM
        incident_status is1
    JOIN (
        SELECT
            incident_ID,
            MAX(timestamp) AS latest_timestamp
        FROM
            incident_status
        GROUP BY
            incident_ID
    ) is2 ON is1.incident_ID = is2.incident_ID
           AND is1.timestamp = is2.latest_timestamp
    JOIN
        status s ON is1.status_ID = s.status_ID
    WHERE (is1.timestamp, is1.i_status_ID) IN (
        SELECT
            MAX(timestamp),
            MAX(i_status_ID)
        FROM
            incident_status
        GROUP BY
            incident_ID
    )
) latest_status ON i.incident_ID = latest_status.incident_ID
JOIN (
    SELECT
        is1.incident_ID AS incident_ID,
        is1.user_ID AS user_ID,
        is1.timestamp AS timestamp,
        u.username AS username
    FROM
        incident_status is1
    JOIN (
        SELECT
            incident_ID,
            MIN(timestamp) AS earliest_timestamp
        FROM
            incident_status
        GROUP BY
            incident_ID
    ) is2 ON is1.incident_ID = is2.incident_ID
           AND is1.timestamp = is2.earliest_timestamp
    JOIN
        user u ON is1.user_ID = u.user_ID
     WHERE (is1.incident_ID, is1.timestamp, is1.i_status_ID) IN (
        SELECT
            incident_ID,
            MIN(timestamp),
            MIN(i_status_ID)
        FROM
            incident_status
        GROUP BY
            incident_ID
    )
) first_reporter ON i.incident_ID = first_reporter.incident_ID

